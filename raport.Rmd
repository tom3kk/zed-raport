---
title: "ZED - raport"
author: "Tomasz Kaik"
date: "`r Sys.Date()`"
output: 
  html_document: 
    keep_md: yes
---

##Wstêp

bla bla bla 

-----

1. Biblioteki i konfiguracja:
```{r libs_opts, results = 'hide', message = FALSE}
library(MASS)
library(dplyr)
library(knitr)
library(ggplot2)
library(gridExtra)

opts_chunk$set(cache = TRUE)
```

2. Zapewnienie powtarzalnoœci wynikóW:
```{r setseed}
set.seed(23)
```

3. Wczytanie danych z pliku:
```{r load_data}
#dane <- read.table("all_summary.txt", header = TRUE, sep = ";", comment.char = "", nrows = 100000)

file <- "all_summary.txt"

# u¿ycie prostej heurystyki do wyznaczenia typów kolumn
header <- read.table(file, header = FALSE, sep = ";", nrows = 1, stringsAsFactors = FALSE)
sample <- read.table(file, header = FALSE, sep = ";", col.names = unlist(header), nrows = 5000, skip = 10000, stringsAsFactors = TRUE)
classes <- sapply(sample, class)
rm(list = c("sample", "header"))

dane <- read.table(file, header = TRUE, sep = ";", comment.char = "", colClasses = classes)

dane <- tbl_df(dane)
```

Liczba wierszy: `r nrow(dane)`

4. Usuniêcie wierszy z niepo¿¹danymi wartoœciami zmiennej res_name:
```{r filter_res_name}
res_name_filter = c('DA','DC','DT', 'DU', 'DG', 'DI','UNK', 'UNX', 'UNL', 'PR', 'PD', 'Y1', 'EU', 'N', '15P', 'UQ', 'PX4', 'NAN')

dane <- dane %>% filter(!(res_name %in% res_name_filter)) 
#%>% filter(!is.na(res_name)) 
```

Liczba wierszy: `r nrow(dane)`

5. Usuniêcie zduplikowanych par wartoœci (pdb_code, res_name):
```{r rm_dupl}
dane <- distinct(dane, pdb_code, res_name)
```

Liczba wierszy: `r nrow(dane)`

6. Krótkie podsumowanie wartoœci w ka¿dej kolumnie:
```{r summary}
#lapply(dane, summary)
summary(dane)
```
Z powy¿szego podsumowania widaæ, ¿e istniej¹ kolumny zawieraj¹ce wy³¹cznie wartoœci puste (NA). Zostan¹ teraz wyœwietlone i usuniête ze zbioru:
```{r rm_all_NA_cols}
colnames(dane)[colSums(is.na(dane)) == nrow(dane)]

dane <- dane[,colSums(is.na(dane)) < nrow(dane)]
```

7. Korelacja miêdzy zmiennymi:
```{r corr}
#TODO
```

8. Liczba przyk³adów dla ka¿dej z klas:
```{r table_class}
table(dane$res_name)
```
Dodatkowo istnieje `r sum(is.na(dane$res_name))` obserwacji bez przypisanej klasy.

9. Rozk³ad liczby atomów (local_res_atom_non_h_count) i elektronów (local_res_atom_non_h_electron_sum):
```{r atom_hist}
hist_atom <- ggplot(dane, aes(x=local_res_atom_non_h_count)) + geom_histogram(binwidth=1, fill="red", colour="black")
hist_atom
```
```{r electron_hist}
hist_electron <- ggplot(dane, aes(x=local_res_atom_non_h_electron_sum)) + geom_histogram(binwidth=6, fill="red", colour="black")
hist_electron
```

10. Próba odtworzenia wykresu:
```{r big_plot}
theme_clear <- theme(axis.ticks=element_blank(), 
            panel.background=element_blank(), 
            axis.text.x=element_blank(), axis.text.y=element_blank(),           
            axis.title.x=element_blank(), axis.title.y=element_blank())

empty <- ggplot() + geom_point(aes(1,1), colour='white') + theme_clear

# density calc (source: http://stackoverflow.com/a/16206373)
x <- dane$local_res_atom_non_h_electron_sum
y <- dane$local_res_atom_non_h_count
dens <- kde2d(x,y)
gr <-data.frame(with(dens, expand.grid(x,y)), as.vector(dens$z))
names(gr) <- c("xgr", "ygr", "zgr")
mod <- loess(zgr~xgr*ygr, data=gr)
dane$pointdens <- predict(mod, newdata=data.frame(xgr=x, ygr=y))

scatter <- ggplot(dane, aes(x=x,y=y,color=pointdens)) + geom_point(position=position_jitter(w = 0.9, h = 0.9)) + scale_colour_gradientn(colours = c('blue','red'), guide = FALSE) + theme_bw() + theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank(),panel.background=element_rect(fill='white',colour='black'))

grid.arrange(
  hist_electron + theme_clear, empty, scatter, hist_atom + coord_flip() + theme_clear,
  ncol=2, nrow=2,widths=c(4,1), heights=c(1,4))
```

11.1. 10 klas z najwiêksz¹ niezgodnoœci¹ liczby atomów:
```{r diff_atom}
dane %>% mutate(diff_atom = abs(local_res_atom_non_h_count - dict_atom_non_h_count)) %>% dplyr::select(res_name,diff_atom) %>% arrange(desc(diff_atom)) %>% distinct(res_name) %>% head(10)
```
11.2. 10 klas z najwiêksz¹ niezgodnoœci¹ liczby elektronów:
```{r diff_electron}
dane %>% mutate(diff_electron = abs(local_res_atom_non_h_electron_sum - dict_atom_non_h_electron_sum)) %>% dplyr::select(res_name,diff_electron) %>% arrange(desc(diff_electron)) %>% distinct(res_name) %>% head(10)
```


